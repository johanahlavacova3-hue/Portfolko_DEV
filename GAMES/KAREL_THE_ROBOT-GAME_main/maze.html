<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Karel The Robot 25' maze</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="sidebar">
  <a href="index.html" class="home-btn">
    <img src="Home.png" alt="Home">
  </a>

  <!-- Počítadlo Beeperů -->
  <div class="beeper-counter">
    <div class="beeper-icon" id="beeper1"></div>
    <div class="beeper-icon" id="beeper2"></div>
    <div class="beeper-icon" id="beeper3"></div>
  </div>

  <textarea id="editor" placeholder="Napiš svůj kód...
například:
move();
turnLeft();
pickBeeper();"></textarea>
  <button id="runBtn"></button>
</div>

<div id="grid"></div>
<img id="wonImage" class="won" src="WON-bright.png" alt="WON">

<script>
// --------------------------------------
// Herní mřížka
// --------------------------------------
const grid = document.getElementById('grid');
const GRID_COLS = 7;
const GRID_ROWS = 4;

// --------------------------------------
// LEVELY
// souřadnice [x, y]:
// x = sloupec zleva doprava (0–6)
// y = řádek shora dolů (0–3)
// start = pozice robota
// walls = kameny (neprůchozí)
// beepers = pozice předmětů
// --------------------------------------
const levels = [
  // Level 1 — jednoduchý
  {
    start: [0, 3],
    walls: [[2, 3], [3, 3], [3, 2]],
    beepers: [[5, 0], [6, 2], [1, 1]]
  },
  // Level 2 — zatáčka
  {
    start: [0, 3],
    walls: [[1, 2], [1, 1], [4, 3], [5, 3], [5, 2]],
    beepers: [[6, 0], [3, 1], [2, 3]]
  },
  // Level 3 — diagonála (opravený)
  {
    start: [0, 3],
    walls: [[1, 3], [2, 2], [3, 1], [4, 0], [5, 0], [6, 0]],
    beepers: [[6, 3], [5, 2], [2, 0]]
  },
  // Level 4 — most s překážkami
  {
    start: [0, 3],
    walls: [[3, 3], [3, 2], [3, 1]],
    beepers: [[6, 0], [0, 0], [2, 1]]
  },
  // Level 5 — malý labyrint
  {
    start: [0, 3],
    walls: [[1, 3], [1, 2], [2, 1], [4, 2], [5, 1], [6, 1]],
    beepers: [[0, 0], [3, 3], [6, 3]]
  },
  // Level 6 — finální (cikcak)
  {
    start: [0, 3],
    walls: [[1, 2], [2, 1], [3, 2], [4, 1], [5, 2]],
    beepers: [[6, 0], [0, 1], [4, 3]]
  }
];

let currentLevel = 0;

// --------------------------------------
// Robot a level setup
// --------------------------------------
const robot = document.createElement('div');
robot.id = 'robot';
grid.appendChild(robot);

let posX = 0, posY = GRID_ROWS - 1, dir = 'right';
let collectedCount = 0;

function createGrid() {
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = `repeat(${GRID_COLS}, 1fr)`;
  grid.style.gridTemplateRows = `repeat(${GRID_ROWS}, 1fr)`;
  for (let i = 0; i < GRID_COLS * GRID_ROWS; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    grid.appendChild(cell);
  }
}

function getCell(x, y) {
  return grid.children[y * GRID_COLS + x];
}

function setupLevel(levelIndex) {
  resetBeeperCounter();
  createGrid();
  const level = levels[levelIndex];
  posX = level.start[0];
  posY = level.start[1];
  dir = 'right';
  updateRobotRotation();

  // Kameny
  level.walls.forEach(([x, y]) => {
    if (x >= 0 && x < GRID_COLS && y >= 0 && y < GRID_ROWS) {
      getCell(x, y).classList.add('wall');
    }
  });

  // Beepery
  level.beepers.forEach(([x, y]) => {
    if (x >= 0 && x < GRID_COLS && y >= 0 && y < GRID_ROWS) {
      const b = document.createElement('div');
      b.className = 'beeper';
      getCell(x, y).appendChild(b);
    }
  });

  getCell(posX, posY).appendChild(robot);
}

createGrid();
setupLevel(currentLevel);

// --------------------------------------
// Pohyb a akce
// --------------------------------------
function updateRobotRotation() {
  let angle = 0;
  if (dir === 'up') angle = -90;
  if (dir === 'down') angle = 90;
  if (dir === 'left') angle = 180;
  robot.style.transform = `rotate(${angle}deg)`;
}

function isWall(x, y) {
  return getCell(x, y).classList.contains('wall');
}

function move() {
  let dx = 0, dy = 0;
  if (dir === 'right') dx = 1;
  if (dir === 'left') dx = -1;
  if (dir === 'up') dy = -1;
  if (dir === 'down') dy = 1;
  const newX = posX + dx, newY = posY + dy;

  if (newX < 0 || newX >= GRID_COLS || newY < 0 || newY >= GRID_ROWS) return;
  if (isWall(newX, newY)) return;

  getCell(posX, posY).removeChild(robot);
  posX = newX; posY = newY;
  getCell(posX, posY).appendChild(robot);
}

function turnLeft() {
  if (dir === 'up') dir = 'left';
  else if (dir === 'left') dir = 'down';
  else if (dir === 'down') dir = 'right';
  else if (dir === 'right') dir = 'up';
  updateRobotRotation();
}

function turnRight() {
  if (dir === 'up') dir = 'right';
  else if (dir === 'right') dir = 'down';
  else if (dir === 'down') dir = 'left';
  else if (dir === 'left') dir = 'up';
  updateRobotRotation();
}

function pickBeeper() {
  const cell = getCell(posX, posY);
  const b = cell.querySelector('.beeper');
  if (b) {
    b.remove();
    collectedCount++;
    updateBeeperCounter(collectedCount);
    checkWin();
  }
}

// --------------------------------------
// Výhra a přechod na další level
// --------------------------------------
function checkWin() {
  if (grid.querySelectorAll('.beeper').length === 0) {
    const wonImg = document.getElementById('wonImage');
    wonImg.style.display = 'block';
    setTimeout(() => {
      wonImg.style.display = 'none';
      nextLevel();
    }, 3000);
  }
}

function nextLevel() {
  currentLevel++;
  if (currentLevel >= levels.length) currentLevel = 0;
  setupLevel(currentLevel);
}

// --------------------------------------
// Počítadlo Beeperů
// --------------------------------------
function resetBeeperCounter() {
  collectedCount = 0;
  document.querySelectorAll('.beeper-icon').forEach(icon => {
    icon.classList.remove('collected', 'blink');
    icon.style.opacity = 0.5;
  });
}

function updateBeeperCounter(index) {
  const icon = document.getElementById(`beeper${index}`);
  if (!icon) return;

  if (icon.classList.contains('collected')) return;

  icon.classList.add('blink');
  icon.addEventListener('animationend', () => {
    icon.classList.remove('blink');
    icon.classList.add('collected');
  }, { once: true });
}

// --------------------------------------
// Spuštění kódu hráče
// --------------------------------------
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

async function runUserCode() {
  setupLevel(currentLevel);
  const code = document.getElementById('editor').value;
  const lines = code.split('\n').filter(l => l.trim() !== '');
  for (let line of lines) {
    try {
      await delay(300);
      eval(line);
    } catch (err) {
      console.error(err);
    }
  }
}

document.getElementById('runBtn').addEventListener('click', runUserCode);
</script>

</body>
</html>
